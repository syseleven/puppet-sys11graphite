#! /bin/bash
#
# This file is managed by puppet.
#

DATE="$(date +%Y-%m-%d)"
DIR="<%= $graphite_db_dumpdir -%>"
FILE="$DIR/graphite-$DATE.sql"

# Generate a dump file
mkdir -p "$DIR"
mysqldump --opt --skip-extended-insert graphite > "$FILE"
gzip -9 "$FILE"

# delete files older than 30 days, keep one file per month
find "$DIR" -name 'graphite-*.sql.gz' -mtime +30 ! -name 'graphite-*-01.sql.gz' -exec rm {} \;

